{% extends "base.html" %}
{% block title %}Dashboard ARE - Régulation Électricité{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
<style>
.kpi-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.kpi-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.kpi-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.alerte-critique {
    border-left: 4px solid #dc3545;
    background-color: #f8d7da;
}

.alerte-elevee {
    border-left: 4px solid #fd7e14;
    background-color: #fff3cd;
}

.carte-rdc {
    height: 400px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    position: relative;
    overflow: hidden;
}

.province-info {
    position: absolute;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    display: none;
    z-index: 1000;
}

.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Dashboard ARE</h1>
                    <p class="text-muted">Tableau de bord stratégique - Année {{ annee }}</p>
                </div>
                <div>
                    {% if current_user.is_super_admin() %}
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-download"></i> Exporter Données
                        </button>
                        <ul class="dropdown-menu">
                            <li><h6 class="dropdown-header">Export Complet</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="exportAllChartsAndTables()">
                                <i class="fas fa-download text-primary"></i> Tous les graphiques et tableaux
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Données Complètes</h6></li>
                            <li><a class="dropdown-item" href="{{ url_for('are_dashboard.export_data', export_type='excel', data_type='all') }}">
                                <i class="fas fa-file-excel text-success"></i> Tout en Excel
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">Par Catégorie</h6></li>
                            <li><a class="dropdown-item" href="{{ url_for('are_dashboard.export_data', export_type='excel', data_type='production') }}">
                                <i class="fas fa-bolt text-warning"></i> Production
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('are_dashboard.export_data', export_type='excel', data_type='capacite') }}">
                                <i class="fas fa-chart-line text-primary"></i> Capacité
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('are_dashboard.export_data', export_type='excel', data_type='kpis') }}">
                                <i class="fas fa-tachometer-alt text-info"></i> KPIs
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('are_dashboard.export_data', export_type='excel', data_type='alertes') }}">
                                <i class="fas fa-exclamation-triangle text-danger"></i> Alertes
                            </a></li>
                        </ul>
                    </div>
                    {% endif %}
                    <a href="{{ url_for('are_dashboard.nouveau_rapport') }}" class="btn btn-primary">
                        <i class="fas fa-file-alt"></i> Nouveau rapport
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            {{ form.annee.label(class="form-label") }}
                            {{ form.annee(class="form-select") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.operateur_id.label(class="form-label") }}
                            {{ form.operateur_id(class="form-select") }}
                        </div>
                        <div class="col-md-3">
                            {{ form.province.label(class="form-label") }}
                            {{ form.province(class="form-select") }}
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter"></i> Filtrer
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="location.href='{{ url_for('are_dashboard.index') }}'">
                                    Réinitialiser
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques générales -->
    <div class="stats-grid">
        <div class="kpi-card">
            <div class="kpi-value">{{ stats.nb_operateurs_actifs }}</div>
            <div class="kpi-label">Opérateurs actifs</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ "{:,.0f}".format(stats.production_totale) }}</div>
            <div class="kpi-label">Production totale (MWh)</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ stats.nb_kpis }}</div>
            <div class="kpi-label">KPIs surveillés</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value">{{ stats.nb_alertes_actives }}</div>
            <div class="kpi-label">Alertes actives</div>
        </div>
    </div>

    <!-- Section: Production annuelle d'énergie électrique -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt text-warning"></i>
                        Production annuelle d'énergie électrique (GWh)
                    </h5>
                    {% if current_user.is_super_admin() %}
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" onclick="exportChart('chartProductionAnnuelle', 'production_annuelle', 'png')" title="Exporter en PNG">
                            <i class="fas fa-image"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="exportChartToExcel('chartProductionAnnuelle', 'production_annuelle')" title="Exporter en Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="exportChartToPDF('chartProductionAnnuelle', 'production_annuelle')" title="Exporter en PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartProductionAnnuelle"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Production {{ stats_nationales.periode.fin }}</h5>
                </div>
                <div class="card-body">
                    {% set derniere_production = stats_nationales.evolution_production[-1] %}
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <span>Hydro:</span>
                                <strong class="text-primary">{{ "{:,.1f}".format(derniere_production.production_hydro_gwh) }} GWh</strong>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-primary" style="width: {{ (derniere_production.production_hydro_gwh / derniere_production.production_totale_gwh * 100) if derniere_production.production_totale_gwh > 0 else 0 }}%"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <span>Thermique:</span>
                                <strong class="text-danger">{{ "{:,.1f}".format(derniere_production.production_thermique_gwh) }} GWh</strong>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-danger" style="width: {{ (derniere_production.production_thermique_gwh / derniere_production.production_totale_gwh * 100) if derniere_production.production_totale_gwh > 0 else 0 }}%"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <span>Solaire:</span>
                                <strong class="text-success">{{ "{:,.1f}".format(derniere_production.production_solaire_gwh) }} GWh</strong>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: {{ (derniere_production.production_solaire_gwh / derniere_production.production_totale_gwh * 100) if derniere_production.production_totale_gwh > 0 else 0 }}%"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total:</strong>
                                <strong class="text-dark">{{ "{:,.1f}".format(derniere_production.production_totale_gwh) }} GWh</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ⚡ Actions Rapides -->
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">⚡ Actions Rapides</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('production_hydro.index') }}" class="btn btn-primary w-100">
                                <i class="fas fa-water"></i> Production Hydro
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('production_thermique.index') }}" class="btn btn-danger w-100">
                                <i class="fas fa-fire"></i> Production Thermique
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('production_solaire.index') }}" class="btn btn-warning w-100">
                                <i class="fas fa-sun"></i> Production Solaire
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('transport.index') }}" class="btn btn-secondary w-100">
                                <i class="fas fa-road"></i> Transport
                            </a>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('distribution.index') }}" class="btn btn-success w-100">
                                <i class="fas fa-network-wired"></i> Distribution
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('operateurs.index') }}" class="btn btn-info w-100">
                                <i class="fas fa-industry"></i> Opérateurs
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('are_dashboard.nouveau_kpi') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-plus"></i> Nouveau KPI
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('are_dashboard.nouveau_rapport') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-file-alt"></i> Nouveau Rapport
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alertes critiques -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Alertes critiques</h5>
                    <a href="{{ url_for('are_dashboard.alertes') }}" class="btn btn-sm btn-outline-primary">
                        Gérer
                    </a>
                </div>
                <div class="card-body">
                    {% if alertes_critiques %}
                        {% for alerte in alertes_critiques %}
                        <div class="mb-3 p-3 rounded {% if alerte.severite.value == 'critique' %}alerte-critique{% else %}alerte-elevee{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <a href="{{ url_for('are_dashboard.detail_alerte', alerte_id=alerte.id) }}" 
                                           class="text-decoration-none text-dark">
                                            {{ alerte.titre }}
                                        </a>
                                    </h6>
                                    <p class="mb-1 small">{{ alerte.description[:100] }}{% if alerte.description|length > 100 %}...{% endif %}</p>
                                    <small class="text-muted">
                                        {{ alerte.entite_concernee }} - 
                                        {{ alerte.date_creation|time_ago }}
                                    </small>
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="badge bg-{% if alerte.severite.value == 'critique' %}danger{% else %}warning{% endif %} mb-2">
                                        {{ alerte.severite.value.title() }}
                                    </span>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <a href="{{ url_for('are_dashboard.detail_alerte', alerte_id=alerte.id) }}" 
                                           class="btn btn-outline-primary btn-sm" title="Voir détails">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if alerte.statut == 'active' %}
                                        <form method="POST" action="{{ url_for('are_dashboard.resoudre_alerte', alerte_id=alerte.id) }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-outline-success btn-sm" 
                                                    title="Résoudre" onclick="return confirm('Résoudre cette alerte ?')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-4">
                            Aucune alerte critique.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Mix énergétique -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Mix énergétique {{ annee }}</h5>
                    {% if current_user.is_super_admin() %}
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" onclick="exportChart('mixEnergetiqueChart', 'mix_energetique', 'png')" title="Exporter en PNG">
                            <i class="fas fa-image"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="exportChartToExcel('mixEnergetiqueChart', 'mix_energetique')" title="Exporter en Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="exportChartToPDF('mixEnergetiqueChart', 'mix_energetique')" title="Exporter en PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="mixEnergetiqueChart"></canvas>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h5 text-info">{{ "{:.1f}%".format(mix_energetique.hydro) }}</div>
                            <small class="text-muted">Hydraulique</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 text-warning">{{ "{:.1f}%".format(mix_energetique.thermique) }}</div>
                            <small class="text-muted">Thermique</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 text-success">{{ "{:.1f}%".format(mix_energetique.solaire) }}</div>
                            <small class="text-muted">Solaire</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance opérateurs -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Top opérateurs par production</h5>
                </div>
                <div class="card-body">
                    {% if performance_operateurs %}
                        {% for perf in performance_operateurs[:5] %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-1">{{ perf.operateur }}</h6>
                                <small class="text-muted">
                                    {{ "{:,.0f}".format(perf.puissance_installee) }} MW installés
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="h6 mb-0">{{ "{:,.0f}".format(perf.production_annuelle) }} MWh</div>
                                <small class="text-muted">{{ "{:.1f}%".format(perf.facteur_charge) }} facteur charge</small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-4">
                            Aucune donnée de performance disponible.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- NOUVELLES STATISTIQUES NATIONALES -->
    {% if stats_nationales %}
    
    <!-- Section: Evolution de la capacité installée -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-primary"></i>
                        Evolution de la capacité installée ({{ stats_nationales.periode.debut }} - {{ stats_nationales.periode.fin }})
                    </h5>
                    {% if current_user.is_super_admin() %}
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-primary" onclick="exportChart('chartCapaciteInstallee', 'evolution_capacite', 'png')" title="Exporter graphique en PNG">
                            <i class="fas fa-image"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="exportTableToExcel('.table-striped', 'evolution_capacite_tableau')" title="Exporter tableau en Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="exportTableToPDF('.table-striped', 'Evolution de la capacité installée', 'evolution_capacite_tableau')" title="Exporter tableau en PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartCapaciteInstallee"></canvas>
                    </div>
                    
                    <!-- Tableau des données -->
                    <div class="table-responsive mt-3">
                        <table class="table table-sm table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Année</th>
                                    <th class="text-end">Hydro (MW)</th>
                                    <th class="text-end">Thermique (MW)</th>
                                    <th class="text-end">Solaire (MW)</th>
                                    <th class="text-end">Total (MW)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in stats_nationales.evolution_capacite %}
                                <tr>
                                    <td><strong>{{ item.annee }}</strong></td>
                                    <td class="text-end">{{ "{:,.1f}".format(item.capacite_hydro_mw) }}</td>
                                    <td class="text-end">{{ "{:,.1f}".format(item.capacite_thermique_mw) }}</td>
                                    <td class="text-end">{{ "{:,.1f}".format(item.capacite_solaire_mw) }}</td>
                                    <td class="text-end"><strong>{{ "{:,.1f}".format(item.capacite_totale_mw) }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section: Clientèle et électrification -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users text-info"></i>
                        Evolution de la clientèle nationale
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartEvolutionClients"></canvas>
                    </div>
                    
                    {% set derniere_clientele = stats_nationales.evolution_clients[-1] %}
                    <div class="row text-center mt-3">
                        <div class="col-4">
                            <h6 class="text-danger">HT</h6>
                            <h4>{{ "{:,}".format(derniere_clientele.clients_ht) }}</h4>
                        </div>
                        <div class="col-4">
                            <h6 class="text-warning">MT</h6>
                            <h4>{{ "{:,}".format(derniere_clientele.clients_mt) }}</h4>
                        </div>
                        <div class="col-4">
                            <h6 class="text-primary">BT</h6>
                            <h4>{{ "{:,}".format(derniere_clientele.clients_bt) }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area text-success"></i>
                        Taux d'électrification et d'accès
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chartTauxElectrification"></canvas>
                    </div>
                    
                    {% set derniers_taux = stats_nationales.taux_electrification[-1] %}
                    <div class="row text-center mt-3">
                        <div class="col-4">
                            <h6 class="text-info">Couverture</h6>
                            <h4>{{ "{:.1f}%".format(derniers_taux.taux_couverture_pct) }}</h4>
                        </div>
                        <div class="col-4">
                            <h6 class="text-warning">Électrification</h6>
                            <h4>{{ "{:.1f}%".format(derniers_taux.taux_electrification_pct) }}</h4>
                        </div>
                        <div class="col-4">
                            <h6 class="text-success">Accès</h6>
                            <h4>{{ "{:.1f}%".format(derniers_taux.taux_acces_pct) }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section: Capacité solaire domestique et factures -->
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-solar-panel text-warning"></i>
                        Solaire domestique
                    </h5>
                </div>
                <div class="card-body">
                    <h3 class="text-warning mb-1">{{ "{:,.1f}".format(stats_nationales.capacite_solaire_domestique[stats_nationales.periode.fin]) }} MW</h3>
                    <p class="text-muted mb-3">Capacité installée {{ stats_nationales.periode.fin }}</p>
                    
                    <div class="small">
                        {% for annee in range(stats_nationales.periode.debut, stats_nationales.periode.fin + 1) %}
                        <div class="d-flex justify-content-between">
                            <span>{{ annee }}:</span>
                            <span>{{ "{:,.1f}".format(stats_nationales.capacite_solaire_domestique[annee]) }} MW</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice text-primary"></i>
                        Facturation nationale
                    </h5>
                </div>
                <div class="card-body">
                    {% set derniere_facturation = stats_nationales.evolution_clients[-1] %}
                    <div class="row g-3">
                        <div class="col-12">
                            <h6>Factures émises</h6>
                            <h4 class="text-primary">{{ "{:,}".format(derniere_facturation.factures_emises) }}</h4>
                        </div>
                        <div class="col-12">
                            <h6>Factures payées</h6>
                            <h4 class="text-success">{{ "{:,}".format(derniere_facturation.factures_payees) }}</h4>
                        </div>
                        <div class="col-12">
                            <h6>Taux de paiement</h6>
                            <h4 class="text-{{ 'success' if derniere_facturation.taux_paiement >= 80 else 'warning' if derniere_facturation.taux_paiement >= 60 else 'danger' }}">
                                {{ "{:.1f}%".format(derniere_facturation.taux_paiement) }}
                            </h4>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-{{ 'success' if derniere_facturation.taux_paiement >= 80 else 'warning' if derniere_facturation.taux_paiement >= 60 else 'danger' }}" 
                                     style="width: {{ derniere_facturation.taux_paiement }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-industry text-secondary"></i>
                        Infrastructure nationale
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-2 small">
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>Centrales hydro:</span>
                                <strong>{{ stats_nationales.stats_infrastructure.nb_centrales_hydro }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>Centrales thermique:</span>
                                <strong>{{ stats_nationales.stats_infrastructure.nb_centrales_thermique }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>Centrales solaire:</span>
                                <strong>{{ stats_nationales.stats_infrastructure.nb_centrales_solaire }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>Réseaux distribution:</span>
                                <strong>{{ stats_nationales.stats_infrastructure.nb_reseaux_distribution }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>Lignes transport:</span>
                                <strong>{{ stats_nationales.stats_infrastructure.nb_lignes_transport }}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between">
                                <span>Postes transport:</span>
                                <strong>{{ stats_nationales.stats_infrastructure.nb_postes_transport }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau synthèse des taux -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-table text-info"></i>
                        Synthèse des taux de couverture, desserte & d'accès à l'électricité ({{ stats_nationales.periode.debut }} - {{ stats_nationales.periode.fin }})
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Année</th>
                                    <th class="text-end">Clients total</th>
                                    <th class="text-end">Personnes desservies</th>
                                    <th class="text-end">Taux couverture (%)</th>
                                    <th class="text-end">Taux électrification (%)</th>
                                    <th class="text-end">Taux d'accès (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in stats_nationales.taux_electrification %}
                                <tr>
                                    <td><strong>{{ item.annee }}</strong></td>
                                    <td class="text-end">{{ "{:,}".format(item.clients) }}</td>
                                    <td class="text-end">{{ "{:,}".format(item.personnes_desservies) }}</td>
                                    <td class="text-end">
                                        <span class="badge bg-{{ 'success' if item.taux_couverture_pct >= 50 else 'warning' if item.taux_couverture_pct >= 25 else 'danger' }}">
                                            {{ "{:.1f}%".format(item.taux_couverture_pct) }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-{{ 'success' if item.taux_electrification_pct >= 40 else 'warning' if item.taux_electrification_pct >= 20 else 'danger' }}">
                                            {{ "{:.1f}%".format(item.taux_electrification_pct) }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-{{ 'success' if item.taux_acces_pct >= 40 else 'warning' if item.taux_acces_pct >= 20 else 'danger' }}">
                                            {{ "{:.1f}%".format(item.taux_acces_pct) }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% endif %}
    <!-- FIN NOUVELLES STATISTIQUES NATIONALES -->

    <!-- Carte RDC interactive -->
    {% if not operateur_id and donnees_provinces %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Indicateurs par province</h5>
                </div>
                <div class="card-body">
                    <div class="carte-rdc" id="carteRDC">
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center">
                                <i class="fas fa-map fa-3x text-muted mb-3"></i>
                                <h5>Carte interactive RDC</h5>
                                <p class="text-muted">
                                    Visualisation des indicateurs par province<br>
                                    (Implémentation SVG/Canvas à prévoir)
                                </p>
                                {% for province_data in donnees_provinces[:3] %}
                                <div class="badge bg-primary me-2 mb-2">
                                    {{ province_data.province }}: {{ "{:.1f}%".format(province_data.taux_acces_electricite or 0) }} accès
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="province-info" id="provinceInfo"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Section: KPIs Stratégiques (déplacée à la fin) -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">KPIs Stratégiques</h5>
                    <a href="{{ url_for('are_dashboard.kpis') }}" class="btn btn-sm btn-outline-primary">
                        Voir tout
                    </a>
                </div>
                <div class="card-body">
                    {% if kpis %}
                        <div class="row">
                            {% for kpi in kpis %}
                            <div class="col-md-4 col-lg-3 mb-3">
                                <div class="border rounded p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ kpi.nom }}</h6>
                                            <div class="h4 mb-1 text-primary">
                                                {{ "{:,.1f}".format(kpi.valeur) }} {{ kpi.unite }}
                                            </div>
                                            {% if kpi.objectif %}
                                            <small class="text-muted">
                                                Objectif: {{ "{:,.1f}".format(kpi.objectif) }} {{ kpi.unite }}
                                            </small>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex align-items-center">
                                            {% if kpi.tendance %}
                                            <div class="me-2">
                                                {% if kpi.tendance.value == 'hausse' %}
                                                    <i class="fas fa-arrow-up text-success"></i>
                                                {% elif kpi.tendance.value == 'baisse' %}
                                                    <i class="fas fa-arrow-down text-danger"></i>
                                                {% else %}
                                                    <i class="fas fa-minus text-warning"></i>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            <form method="POST" action="{{ url_for('are_dashboard.supprimer_kpi', kpi_id=kpi.id) }}" 
                                                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce KPI ?')" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Supprimer ce KPI">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">
                            Aucun KPI disponible pour les critères sélectionnés.
                            <br>
                            <a href="{{ url_for('are_dashboard.nouveau_kpi') }}" class="btn btn-sm btn-primary mt-2">
                                Créer un KPI
                            </a>
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/are/dashboard.js') }}"></script>
<script>
{% raw %}
// Initialisation du dashboard avec les données du template
document.addEventListener('DOMContentLoaded', function() {
    if (window.dashboardARE) {
        // Passer les données du template au JavaScript
        window.dashboardData = {
            mixEnergetique: {
                hydro: { mix_energetique.hydro },
                thermique: { mix_energetique.thermique },
                solaire: { mix_energetique.solaire }
            },
            annee: { annee },
            operateurId: { operateur_id or 'null' },
            donneesProvinces: { donnees_provinces|tojson if donnees_provinces else '[]' }
        };
        
        // Initialiser les graphiques avec les données
        window.dashboardARE.initWithData(window.dashboardData);
    }
    
    // =============== NOUVEAUX GRAPHIQUES POUR STATISTIQUES NATIONALES ===============
    {% if stats_nationales %}
    
    // Configuration commune Chart.js
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#666';
    
    // =========== GRAPHIQUE: Evolution de la capacité installée ===========
    const ctxCapacite = document.getElementById('chartCapaciteInstallee').getContext('2d');
    new Chart(ctxCapacite, {
        type: 'line',
        data: {
            labels: [{% for item in stats_nationales.evolution_capacite %}'{ item.annee }'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Hydro (MW)',
                data: [{% for item in stats_nationales.evolution_capacite %}{ item.capacite_hydro_mw }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }, {
                label: 'Thermique (MW)',
                data: [{% for item in stats_nationales.evolution_capacite %}{ item.capacite_thermique_mw }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }, {
                label: 'Solaire (MW)',
                data: [{% for item in stats_nationales.evolution_capacite %}{ item.capacite_solaire_mw }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolution de la capacité installée par source d\'énergie'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Capacité (MW)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' MW';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Année'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // =========== GRAPHIQUE: Production annuelle d'énergie ===========
    const ctxProduction = document.getElementById('chartProductionAnnuelle').getContext('2d');
    new Chart(ctxProduction, {
        type: 'bar',
        data: {
            labels: [{% for item in stats_nationales.evolution_production %}'{ item.annee }'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Hydro (GWh)',
                data: [{% for item in stats_nationales.evolution_production %}{ item.production_hydro_gwh }{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(13, 110, 253, 0.8)',
                borderColor: '#0d6efd',
                borderWidth: 1
            }, {
                label: 'Thermique (GWh)',
                data: [{% for item in stats_nationales.evolution_production %}{ item.production_thermique_gwh }{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                borderColor: '#dc3545',
                borderWidth: 1
            }, {
                label: 'Solaire (GWh)',
                data: [{% for item in stats_nationales.evolution_production %}{ item.production_solaire_gwh }{% if not loop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(25, 135, 84, 0.8)',
                borderColor: '#198754',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Production annuelle d\'énergie électrique par source'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Année'
                    }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Production (GWh)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' GWh';
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // =========== GRAPHIQUE: Evolution de la clientèle ===========
    const ctxClients = document.getElementById('chartEvolutionClients').getContext('2d');
    new Chart(ctxClients, {
        type: 'line',
        data: {
            labels: [{% for item in stats_nationales.evolution_clients %}'{ item.annee }'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Clients HT',
                data: [{% for item in stats_nationales.evolution_clients %}{ item.clients_ht }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }, {
                label: 'Clients MT',
                data: [{% for item in stats_nationales.evolution_clients %}{ item.clients_mt }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#fd7e14',
                backgroundColor: 'rgba(253, 126, 20, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }, {
                label: 'Clients BT',
                data: [{% for item in stats_nationales.evolution_clients %}{ item.clients_bt }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolution du nombre de clients par niveau de tension'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre de clients'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Année'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // =========== GRAPHIQUE: Taux d'électrification ===========
    const ctxTaux = document.getElementById('chartTauxElectrification').getContext('2d');
    new Chart(ctxTaux, {
        type: 'line',
        data: {
            labels: [{% for item in stats_nationales.taux_electrification %}'{ item.annee }'{% if not loop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'Taux de couverture (%)',
                data: [{% for item in stats_nationales.taux_electrification %}{ "%.2f"|format(item.taux_couverture_pct) }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }, {
                label: 'Taux d\'électrification (%)',
                data: [{% for item in stats_nationales.taux_electrification %}{ "%.2f"|format(item.taux_electrification_pct) }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#fd7e14',
                backgroundColor: 'rgba(253, 126, 20, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }, {
                label: 'Taux d\'accès (%)',
                data: [{% for item in stats_nationales.taux_electrification %}{ "%.2f"|format(item.taux_acces_pct) }{% if not loop.last %},{% endif %}{% endfor %}],
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolution des taux d\'électrification, de couverture et d\'accès'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Pourcentage (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Année'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // Fonction pour mettre à jour la hauteur des conteneurs de graphiques
    function updateChartContainers() {
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
            container.style.height = '350px';
            container.style.position = 'relative';
        });
    }
    
    // Appliquer la hauteur aux conteneurs
    updateChartContainers();
    
    // Réajuster lors du redimensionnement de la fenêtre
    window.addEventListener('resize', updateChartContainers);
    
    console.log('✅ Graphiques des statistiques nationales ARE initialisés');
    
    {% endif %}
    // =============== FIN NOUVEAUX GRAPHIQUES ===============
});

// =============== FONCTIONS D'EXPORT ===============

// Export de tous les graphiques et tableaux de la page
function exportAllChartsAndTables() {
    if (!confirm('Voulez-vous exporter tous les graphiques et tableaux de cette page?')) {
        return;
    }
    
    // Export des graphiques
    const charts = ['chartProductionAnnuelle', 'mixEnergetiqueChart', 'chartCapaciteInstallee'];
    charts.forEach((chartId, index) => {
        setTimeout(() => {
            const chart = Chart.getChart(chartId);
            if (chart) {
                const url = chart.toBase64Image();
                const link = document.createElement('a');
                link.download = `dashboard_${chartId}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = url;
                link.click();
            }
        }, index * 500); // Délai pour éviter les téléchargements simultanés
    });
    
    // Export des tableaux
    setTimeout(() => {
        const tables = document.querySelectorAll('.table');
        tables.forEach((table, index) => {
            setTimeout(() => {
                const title = table.closest('.card')?.querySelector('.card-header h5')?.textContent || `Tableau_${index + 1}`;
                exportTableToExcel(`table:nth-of-type(${index + 1})`, title.replace(/\s+/g, '_'));
            }, index * 500);
        });
    }, charts.length * 500);
}

// Export de graphique en PNG
function exportChart(chartId, filename, format = 'png') {
    const chart = Chart.getChart(chartId);
    if (!chart) {
        alert('Graphique non trouvé');
        return;
    }
    
    const url = chart.toBase64Image();
    const link = document.createElement('a');
    link.download = `${filename}_${new Date().toISOString().split('T')[0]}.${format}`;
    link.href = url;
    link.click();
}

// Export de graphique vers Excel
function exportChartToExcel(chartId, filename) {
    const chart = Chart.getChart(chartId);
    if (!chart) {
        alert('Graphique non trouvé');
        return;
    }
    
    // Extraire les données du graphique
    const data = chart.data;
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // En-têtes
    csvContent += "Catégorie," + data.datasets.map(dataset => dataset.label).join(",") + "\n";
    
    // Données
    data.labels.forEach((label, index) => {
        let row = label + ",";
        row += data.datasets.map(dataset => dataset.data[index] || 0).join(",");
        csvContent += row + "\n";
    });
    
    // Télécharger
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
    link.click();
}

// Export de graphique vers PDF
function exportChartToPDF(chartId, filename) {
    const chart = Chart.getChart(chartId);
    if (!chart) {
        alert('Graphique non trouvé');
        return;
    }
    
    // Créer une nouvelle fenêtre pour l'impression
    const printWindow = window.open('', '_blank');
    const chartContainer = document.getElementById(chartId).parentElement;
    const title = chartContainer.closest('.card').querySelector('.card-header h5').textContent;
    
    printWindow.document.write(`
        <html>
            <head>
                <title>${title}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .chart-container { text-align: center; }
                    h1 { color: #333; margin-bottom: 20px; }
                    .export-info { margin-top: 20px; font-size: 12px; color: #666; }
                </style>
            </head>
            <body>
                <h1>${title}</h1>
                <div class="chart-container">
                    <img src="${chart.toBase64Image()}" style="max-width: 100%; height: auto;" />
                </div>
                <div class="export-info">
                    <p>Exporté le ${new Date().toLocaleDateString('fr-FR')} depuis le Dashboard ARE</p>
                </div>
            </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Attendre que l'image soit chargée puis imprimer
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 1000);
}

// Export de tableau vers Excel
function exportTableToExcel(tableSelector, filename) {
    const table = document.querySelector(tableSelector);
    if (!table) {
        alert('Tableau non trouvé');
        return;
    }
    
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // En-têtes
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
    csvContent += headers.join(",") + "\n";
    
    // Données
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = Array.from(row.querySelectorAll('td')).map(td => {
            // Nettoyer le texte et échapper les virgules
            return '"' + td.textContent.trim().replace(/"/g, '""') + '"';
        });
        csvContent += cells.join(",") + "\n";
    });
    
    // Télécharger
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
    link.click();
}

// Export de tableau vers PDF
function exportTableToPDF(tableSelector, title, filename) {
    const table = document.querySelector(tableSelector);
    if (!table) {
        alert('Tableau non trouvé');
        return;
    }
    
    // Créer une nouvelle fenêtre pour l'impression
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <html>
            <head>
                <title>${title}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; font-weight: bold; }
                    h1 { color: #333; margin-bottom: 20px; }
                    .export-info { margin-top: 20px; font-size: 12px; color: #666; }
                    @media print {
                        body { margin: 0; }
                        table { font-size: 12px; }
                    }
                </style>
            </head>
            <body>
                <h1>${title}</h1>
                ${table.outerHTML}
                <div class="export-info">
                    <p>Exporté le ${new Date().toLocaleDateString('fr-FR')} depuis le Dashboard ARE</p>
                </div>
            </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Imprimer
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 1000);
}

// =============== FIN FONCTIONS D'EXPORT ===============
{% endraw %}
</script>
{% endblock %}