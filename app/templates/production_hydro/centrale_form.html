{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
.centrale-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border-left: 4px solid #007bff;
}

.centrale-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.centrale-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.centrale-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.tech-specs {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
}

.equipment-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
}

.spec-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.spec-row:last-child {
    margin-bottom: 0;
}

.map-container {
    height: 300px;
    width: 100%;
    border-radius: 10px;
    margin-top: 1rem;
    border: 1px solid #dee2e6;
}

.form-section {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.form-section h5 {
    color: #007bff;
    margin-bottom: 1.5rem;
    font-weight: 600;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.75rem;
}

.equipment-formset {
    border: 1px solid #dee2e6;
    border-radius: 10px;
    margin-bottom: 1.5rem;
}

.equipment-header {
    background: #e9ecef;
    padding: 1rem;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.equipment-item {
    padding: 1.5rem;
    border-bottom: 1px solid #dee2e6;
    position: relative;
}

.equipment-item:last-child {
    border-bottom: none;
}

.equipment-item.to-delete {
    opacity: 0.5;
    background-color: #f8d7da;
}

.delete-btn {
    position: absolute;
    top: 1rem;
    right: 1rem;
}

.add-btn {
    background: #28a745;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s;
}

.add-btn:hover {
    background: #218838;
}

.required-field label::after {
    content: " *";
    color: #dc3545;
}

.help-text {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.map-container {
    height: 300px;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 1rem;
}

.coordinates-display {
    background: #e9ecef;
    border-radius: 5px;
    padding: 0.5rem;
    margin-top: 0.5rem;
    font-family: monospace;
    font-size: 0.9rem;
}

@media (max-width: 768px) {
    .centrale-header {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .centrale-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">
        <i class="fas fa-{{ 'plus' if request.endpoint.endswith('create') else 'edit' if centrale else 'industry' }} me-2 text-primary"></i>
        {{ title }}
    </h1>
    {% if not request.endpoint.endswith('create') %}
    <a href="{{ url_for('production_hydro.centrales') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Retour à la liste
    </a>
    {% endif %}
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{% if centrale and not request.endpoint.endswith('edit') %}
    <!-- Vue détaillée de la centrale -->
    {% include 'production_hydro/composants_new_centrales/details_centrales.html' %}
{% else %}
<!-- Formulaire de création/édition -->
<form method="POST" id="centraleForm" novalidate>
    {{ form.hidden_tag() }}
    {{ form.csrf_token }}
    
    <!-- Informations générales -->
    {% include 'production_hydro/composants_new_centrales/info_generale.html' %}
    
    <!-- Caractéristiques techniques -->
    {% include 'production_hydro/composants_new_centrales/cara_tech.html' %}
    
    <!-- Localisation géographique -->
    {% include 'production_hydro/composants_new_centrales/loca_geo.html' %}
    
    <!-- Note: Les équipements (groupes et transformateurs) seront ajoutés séparément après la création -->
    
    <!-- Boutons de soumission -->
    <div class="form-section">
        <div class="d-flex justify-content-between">
            <a href="{{ url_for('production_hydro.centrales') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-1"></i>Annuler
            </a>
            <div>
                {{ form.submit(class="btn btn-primary") }}
            </div>
        </div>
    </div>
</form>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script> 
    // Validation du formulaire
    document.getElementById('centraleForm')?.addEventListener('submit', function(e) {
        const requiredFields = this.querySelectorAll('[required]');
        let isValid = true;
        let firstInvalid = null;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
                if (!firstInvalid) firstInvalid = field;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            firstInvalid.focus();
            // Message d'erreur plus détaillé
            const invalidCount = document.querySelectorAll('.is-invalid').length;
            alert(`Veuillez remplir tous les champs obligatoires (${invalidCount} champ${invalidCount > 1 ? 's' : ''} manquant${invalidCount > 1 ? 's' : ''}).`);
        }
    });

    // Gestionnaire d'erreurs global
    window.addEventListener('error', function(e) {
        console.error('Erreur JavaScript:', e.message);
    });

    // Protection contre la double soumission
    const form = document.getElementById('centraleForm');
    if (form) {
        form.addEventListener('submit', function() {
            // Désactiver le bouton de soumission
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Traitement...';
            }
        });
    }

    // Géolocalisation et carte interactive
    let map = null;
    let marker = null;

    // Initialiser les événements de géolocalisation au chargement
    document.addEventListener('DOMContentLoaded', function() {
        // Mettre à jour l'affichage des coordonnées si elles existent
        updateCoordinatesDisplay();

        // Événements pour les champs de coordonnées
        const latField = document.getElementById('latitude');
        const lngField = document.getElementById('longitude');
        if (latField && lngField) {
            latField.addEventListener('input', updateCoordinatesDisplay);
            lngField.addEventListener('input', updateCoordinatesDisplay);
        }
    });

    function obtenirPosition() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                const latField = document.getElementById('latitude');
                const lngField = document.getElementById('longitude');

                if (latField && lngField) {
                    latField.value = lat.toFixed(6);
                    lngField.value = lng.toFixed(6);

                    updateCoordinatesDisplay();

                    if (map) {
                        map.setView([lat, lng], 13);
                        if (marker) {
                            marker.setLatLng([lat, lng]);
                        } else {
                            marker = L.marker([lat, lng]).addTo(map);
                        }
                    }
                }
            }, function(error) {
                alert('Erreur lors de l\'obtention de la position: ' + error.message);
            });
        } else {
            alert('La géolocalisation n\'est pas supportée par ce navigateur.');
        }
    }

    function afficherCarte() {
        const mapContainer = document.getElementById('map-selector');
        if (!mapContainer) return;

        mapContainer.style.display = 'block';

        if (!map) {
            // Centre de la RDC
            const rdcCenter = [-4.038333, 21.758664];
            map = L.map('map-selector').setView(rdcCenter, 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Ajouter un marqueur existant si les coordonnées sont remplies
            const lat = parseFloat(document.getElementById('latitude')?.value || '');
            const lng = parseFloat(document.getElementById('longitude')?.value || '');

            if (!isNaN(lat) && !isNaN(lng)) {
                marker = L.marker([lat, lng]).addTo(map);
                map.setView([lat, lng], 13);
            }

            // Événement clic sur la carte
            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;

                const latField = document.getElementById('latitude');
                const lngField = document.getElementById('longitude');

                if (latField && lngField) {
                    latField.value = lat.toFixed(6);
                    lngField.value = lng.toFixed(6);

                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        marker = L.marker([lat, lng]).addTo(map);
                    }

                    updateCoordinatesDisplay();
                }
            });
        }

        // Redimensionner la carte après un court délai
        setTimeout(() => {
            if (map) map.invalidateSize();
        }, 100);
    }

    function updateCoordinatesDisplay() {
        const lat = document.getElementById('latitude')?.value || '';
        const lng = document.getElementById('longitude')?.value || '';
        const display = document.getElementById('coordinates-display');
        const coordText = document.getElementById('coord-text');

        if (display && coordText && lat && lng) {
            display.style.display = 'block';
            coordText.textContent = `${lat}, ${lng}`;
        } else if (display) {
            display.style.display = 'none';
        }
    }
</script>

<!-- Styles pour la carte -->
<style>
.map-container {
    height: 400px;
    width: 100%;
    margin-top: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.coordinates-display {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-family: monospace;
}
</style>
{% endblock %}